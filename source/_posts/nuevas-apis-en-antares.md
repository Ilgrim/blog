---
title: "Nuevas APIs en Antares"
date: 2013-07-29 08:26:28
tags: 
---
<p style="text-align: justify;">Mientras hacía en Antares el sistema de renderizado a textura necesité usar una versión superior del <em>binding</em> que usaba de OpenGL, JOGL. Este binding pertenece a <a href="http://jogamp.org/" target="_blank">JogAmp</a>, un proyecto que incluye una serie de bindings para Java. Y ya que me iba a descargar la última versión de estas librerías, no me limité a coger sólo el <em>binding</em> para OpenGL, sino que cogí el paquete entero, que incluye <em>bindings</em> para OpenCL y OpenAL. Y he estado usando estas librerías.</p>
<p style="text-align: justify;">OpenCL es similar a OpenGL, pero en vez de <em>Graphics</em> <em>Library</em>, significa <em>Computing</em> <em>Library</em>. Su paradigma es muy similar, tú únicamente haces llamadas de configuración y otras para establecer <em>buffers</em> que contienen los datos a procesar, y especificas también el código fuente de un programa a ejecutar. En OpenGL especificas un programa en GLSL (Shading Language), que se ejecuta para cada píxel de los triángulos que dibujas, y calcula el color del píxel en cuestión. En OpenCL el programa está en... CL (la extension es .cl), es un lenguaje parecido a GLSL, pero más orientado a cálculos genéricos, no orientados a gráficos, y así este programa puede realizar cualquier cálculo sobre los datos de entrada y generar una salida. Además los <em>buffers</em> de OpenGL y OpenCL pueden ser compartidos, así que puedes calcular datos y usarlos para dibujar algo, muy rápidamente.</p>
<p style="text-align: justify;">La otra librería, OpenAL, significa <em>Audio Library</em>, y te permite usar el sonido 3d acelerado por <em>hardware</em>. El sonido 3d significa que puede variar el <em>panning</em> de un sonido, su volumen y su frecuencia según la posición del que escucha y de las fuentes de sonido, y de sus velocidades. Aún no he usado sonido 3d para Antares, sólo he reproducido sonidos sin propiedades 3d. Eso parece más adecuado para un simulador de coches o un FPS. Otra cosa que he intentado es la decodificación Ogg Vorbis, pero ya no funciona (antes lo hacía)...</p>
<p style="text-align: justify;">Bueno, y ¿qué he hecho en OpenCL?  He estado simulando partículas. Fácilmente se puede simular el movimiento de millones de partículas. La verdad, son muchas, más que para llenar la pantalla. Ahora bien, si quieres que tengan interacción entre ellas (que colisionen, tengan atracción gravitatoria entre ellas o se repelan), el número de partículas que se pueden simular a un <em>framerate</em> aceptable son unas 10.000 (30 <em>fps</em>).</p>
<p style="text-align: justify;">No pongo fotos porque lo bonito es verlo simulándose, y tampoco vale la pena un vídeo. La verdad, no he conseguido gran cosa. Intenté hacer un "sólido" formado por partículas, pero perdía su forma (las partículas se desmoronaban y empezaban a intercambiarse) antes de que el objeto tocase el suelo y pudiese ver un rebote bonito, sólo rebotaba una masa de partículas informe.</p>
<p style="text-align: justify;">Otra prueba que he hecho es con partículas que empiezan con forma de disco rotatorio y se atraen entre sí, y cuando se tocan dos de ellas se fusionan en una sola. Quedaba más o menos bien, al final aparecía una sola pelota con varias más pequeñas orbitando, pero eso es todo.</p>
<p style="text-align: justify;">Lo bonito de OpenCL es que puedes paralelizar mucho el cálculo. Mi tarjeta 3D tiene 1024 "unidades de ejecución" o como las llamen (<em>workgroup</em> creo), lo que significa que puede realmente haber 1024 threads, ocupándose cada uno del cálculo de una sola partícula, y cogiendo una nueva cuando termina, hasta completar todas las partículas en cada <em>frame</em>. Cada thread tiene disponibles las posiciones y velocidades de las partículas en el <em>frame</em> anterior, y escribe únicamente la posición y velocidad nuevas de la partícula que está procesando, en un búfer diferente, de esta forma se puede paralelizar todo el cálculo.</p>
<p style="text-align: justify;">Hasta la próxima!</p>